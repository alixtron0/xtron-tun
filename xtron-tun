#!/bin/bash

#############################################
# XTRON-TUN Main Management Script
# GitHub: alixtron0/xtron-tun
# Author: AliXtron
# Description: Professional SMTP Tunnel Manager
#############################################

set -euo pipefail

# Source library files
LIB_DIR="/usr/local/lib/xtron-tun"
CONFIG_DIR="/etc/xtron-tun"
LOG_DIR="/var/log/xtron-tun"

# Try to source utils, if not available use embedded functions
if [[ -f "${LIB_DIR}/utils.sh" ]]; then
    source "${LIB_DIR}/utils.sh"
else
    # Embedded minimal utils for standalone execution (only if utils.sh not found)
    readonly RED='\033[0;31m'
    readonly GREEN='\033[0;32m'
    readonly YELLOW='\033[1;33m'
    readonly BLUE='\033[0;34m'
    readonly CYAN='\033[0;36m'
    readonly WHITE='\033[1;37m'
    readonly NC='\033[0m'
fi

# Check if running as root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        echo -e "${RED}✗ This script must be run as root or with sudo${NC}"
        exit 1
    fi
}

# Show main banner
show_banner() {
    clear
    echo -e "${CYAN}"
    cat << "EOF"
╔═══════════════════════════════════════════════════════════╗
║                                                           ║
║     ██╗  ██╗████████╗██████╗  ██████╗ ███╗   ██╗        ║
║     ╚██╗██╔╝╚══██╔══╝██╔══██╗██╔═══██╗████╗  ██║        ║
║      ╚███╔╝    ██║   ██████╔╝██║   ██║██╔██╗ ██║        ║
║      ██╔██╗    ██║   ██╔══██╗██║   ██║██║╚██╗██║        ║
║     ██╔╝ ██╗   ██║   ██║  ██║╚██████╔╝██║ ╚████║        ║
║     ╚═╝  ╚═╝   ╚═╝   ╚═╝  ╚═╝ ╚═════╝ ╚═╝  ╚═══╝        ║
║                                                           ║
║         Professional SMTP Tunnel Manager                 ║
║                    Version 1.0.0                         ║
║                                                           ║
╚═══════════════════════════════════════════════════════════╝
EOF
    echo -e "${NC}\n"
}

# Show main menu
show_main_menu() {
    echo -e "${CYAN}╔═══════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║${NC}                    ${WHITE}Main Menu${NC}                             ${CYAN}║${NC}"
    echo -e "${CYAN}╠═══════════════════════════════════════════════════════════╣${NC}"
    echo -e "${CYAN}║${NC}                                                           ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  ${GREEN}1${NC} • ${WHITE}Foreign Server (Kharej)${NC}                             ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}      Setup and manage tunnel on foreign server           ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}                                                           ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  ${GREEN}2${NC} • ${WHITE}Iran Server${NC}                                         ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}      Setup and manage tunnel on Iran server               ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}                                                           ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  ${YELLOW}3${NC} • ${WHITE}Settings & Configuration${NC}                           ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}                                                           ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  ${YELLOW}4${NC} • ${WHITE}View Logs${NC}                                           ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}                                                           ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  ${YELLOW}5${NC} • ${WHITE}About XTRON-TUN${NC}                                     ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}                                                           ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  ${RED}0${NC} • ${WHITE}Exit${NC}                                                 ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}                                                           ${CYAN}║${NC}"
    echo -e "${CYAN}╚═══════════════════════════════════════════════════════════╝${NC}"
    echo -e ""
}

# Kharej (Foreign) server menu
kharej_menu() {
    if [[ -f "${LIB_DIR}/kharej.sh" ]]; then
        source "${LIB_DIR}/kharej.sh"
        kharej_main
    else
        echo -e "${RED}✗ Kharej module file not found!${NC}"
        echo -e "${YELLOW}Creating module...${NC}"
        sleep 2
        show_kharej_placeholder
    fi
}

# Iran server menu
iran_menu() {
    if [[ -f "${LIB_DIR}/iran.sh" ]]; then
        source "${LIB_DIR}/iran.sh"
        iran_main
    else
        echo -e "${RED}✗ Iran module file not found!${NC}"
        echo -e "${YELLOW}Creating module...${NC}"
        sleep 2
        show_iran_placeholder
    fi
}

# Placeholder for Kharej module
show_kharej_placeholder() {
    clear
    show_banner
    echo -e "${CYAN}╔═══════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║${NC}              ${WHITE}Foreign Server (Kharej)${NC}                      ${CYAN}║${NC}"
    echo -e "${CYAN}╠═══════════════════════════════════════════════════════════╣${NC}"
    echo -e "${CYAN}║${NC}                                                           ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  ${GREEN}1${NC} • ${WHITE}Setup New Tunnel${NC}                                    ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}      Create SOCKS5 proxy and SMTP tunnel                 ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}                                                           ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  ${GREEN}2${NC} • ${WHITE}Manage Tunnels${NC}                                      ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}      • View tunnel status                                 ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}      • Add/Remove users                                   ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}      • Connection test (Ping Test)                        ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}                                                           ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  ${GREEN}3${NC} • ${WHITE}Export Configuration${NC}                                ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}      Get ZIP file for Iran server                         ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}                                                           ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  ${RED}4${NC} • ${WHITE}Delete Tunnel${NC}                                       ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}      Complete removal and cleanup                         ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}                                                           ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  ${YELLOW}0${NC} • ${WHITE}Back${NC}                                                 ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}                                                           ${CYAN}║${NC}"
    echo -e "${CYAN}╚═══════════════════════════════════════════════════════════╝${NC}"

    read -p "$(echo -e ${WHITE}'Your choice: '${NC})" choice
    echo -e "${YELLOW}This section is under development...${NC}"
    sleep 2
}

# Placeholder for Iran module
show_iran_placeholder() {
    clear
    show_banner
    echo -e "${CYAN}╔═══════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║${NC}                  ${WHITE}Iran Server${NC}                             ${CYAN}║${NC}"
    echo -e "${CYAN}╠═══════════════════════════════════════════════════════════╣${NC}"
    echo -e "${CYAN}║${NC}                                                           ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  ${GREEN}1${NC} • ${WHITE}Setup Tunnel${NC}                                        ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}      Connect to foreign server with ZIP file             ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}                                                           ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  ${GREEN}2${NC} • ${WHITE}Port Forward${NC}                                         ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}      • Choose engine (GOST / socat)                       ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}      • Define new ports                                   ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}                                                           ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  ${GREEN}3${NC} • ${WHITE}Manage Tunnels${NC}                                      ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}      • View status                                        ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}      • Ping Test                                          ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}      • Manage Port Forwards                               ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}                                                           ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  ${RED}4${NC} • ${WHITE}Delete & Cleanup${NC}                                    ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}      Complete removal and cleanup                         ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}                                                           ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  ${YELLOW}0${NC} • ${WHITE}Back${NC}                                                 ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}                                                           ${CYAN}║${NC}"
    echo -e "${CYAN}╚═══════════════════════════════════════════════════════════╝${NC}"

    read -p "$(echo -e ${WHITE}'Your choice: '${NC})" choice
    echo -e "${YELLOW}This section is under development...${NC}"
    sleep 2
}

# Settings menu
settings_menu() {
    clear
    show_banner
    echo -e "${CYAN}╔═══════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║${NC}            ${WHITE}Settings & Configuration${NC}                      ${CYAN}║${NC}"
    echo -e "${CYAN}╠═══════════════════════════════════════════════════════════╣${NC}"
    echo -e "${CYAN}║${NC}                                                           ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  System directories:                                      ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  • Config: ${WHITE}${CONFIG_DIR}${NC}                ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  • Logs:   ${WHITE}${LOG_DIR}${NC}                  ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}                                                           ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  Installed tools:                                         ${CYAN}║${NC}"

    if command -v gost >/dev/null 2>&1; then
        local gost_ver=$(gost -V 2>&1 | head -1 || echo "unknown")
        echo -e "${CYAN}║${NC}  • GOST:   ${GREEN}Installed${NC} (${gost_ver:0:20})              ${CYAN}║${NC}"
    else
        echo -e "${CYAN}║${NC}  • GOST:   ${RED}Not installed${NC}                                ${CYAN}║${NC}"
    fi

    if command -v socat >/dev/null 2>&1; then
        local socat_ver=$(socat -V 2>&1 | head -1 | grep -oP '\d+\.\d+\.\d+' || echo "unknown")
        echo -e "${CYAN}║${NC}  • socat:  ${GREEN}Installed${NC} (v${socat_ver})                         ${CYAN}║${NC}"
    else
        echo -e "${CYAN}║${NC}  • socat:  ${RED}Not installed${NC}                                ${CYAN}║${NC}"
    fi

    echo -e "${CYAN}║${NC}                                                           ${CYAN}║${NC}"
    echo -e "${CYAN}╚═══════════════════════════════════════════════════════════╝${NC}"
    echo -e ""
    read -p "$(echo -e ${YELLOW}'Press Enter to go back...'${NC})"
}

# Show logs
show_logs() {
    clear
    show_banner
    echo -e "${CYAN}╔═══════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║${NC}                      ${WHITE}Logs${NC}                                  ${CYAN}║${NC}"
    echo -e "${CYAN}╚═══════════════════════════════════════════════════════════╝${NC}\n"

    if [[ -d "$LOG_DIR" ]] && [[ $(ls -A "$LOG_DIR") ]]; then
        echo -e "${WHITE}Recent logs:${NC}\n"
        tail -n 30 "$LOG_DIR"/*.log 2>/dev/null || echo -e "${YELLOW}No logs found${NC}"
    else
        echo -e "${YELLOW}No logs found${NC}"
    fi

    echo -e ""
    read -p "$(echo -e ${YELLOW}'Press Enter to go back...'${NC})"
}

# About
show_about() {
    clear
    show_banner
    echo -e "${CYAN}╔═══════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║${NC}                ${WHITE}About XTRON-TUN${NC}                              ${CYAN}║${NC}"
    echo -e "${CYAN}╠═══════════════════════════════════════════════════════════╣${NC}"
    echo -e "${CYAN}║${NC}                                                           ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  ${WHITE}Name:${NC}         XTRON Tunnel Manager                        ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  ${WHITE}Version:${NC}      1.0.0                                         ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  ${WHITE}Author:${NC}       AliXtron                                      ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  ${WHITE}Repository:${NC}   github.com/alixtron0/xtron-tun                ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}                                                           ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  ${WHITE}Description:${NC}                                               ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  Professional SMTP tunnel management tool for Iran       ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  and foreign servers with GOST and socat support         ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}                                                           ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  ${WHITE}Features:${NC}                                                  ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  • Easy SMTP tunnel setup                                 ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  • SOCKS5 Proxy support                                   ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  • Complete Port Forwarding management                    ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  • Beautiful and user-friendly interface                  ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  • Advanced monitoring and logging                        ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}                                                           ${CYAN}║${NC}"
    echo -e "${CYAN}╚═══════════════════════════════════════════════════════════╝${NC}"
    echo -e ""
    read -p "$(echo -e ${YELLOW}'Press Enter to go back...'${NC})"
}

# Main loop
main() {
    check_root

    while true; do
        show_banner
        show_main_menu

        read -p "$(echo -e ${WHITE}'Your choice: '${NC})" choice

        case $choice in
            1)
                kharej_menu
                ;;
            2)
                iran_menu
                ;;
            3)
                settings_menu
                ;;
            4)
                show_logs
                ;;
            5)
                show_about
                ;;
            0)
                echo -e "\n${GREEN}Goodbye!${NC}\n"
                exit 0
                ;;
            *)
                echo -e "${RED}Invalid choice!${NC}"
                sleep 1
                ;;
        esac
    done
}

# Help message
if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
    show_banner
    echo -e "${WHITE}Usage:${NC}"
    echo -e "  xtron-tun              Start tunnel manager"
    echo -e "  xtron-tun --help       Show this help message\n"
    exit 0
fi

# Run main
main "$@"
